<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32S3 TTS Demo</title>
    <style>
        :root { color-scheme: light dark; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
        h1 { font-size: 20px; margin: 0 0 12px; }
        .row { display: flex; align-items: center; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
        button { padding: 6px 10px; cursor: pointer; }
        textarea { width: 100%; min-height: 96px; padding: 8px; box-sizing: border-box; }
        ul { list-style: none; padding: 0; margin: 8px 0 0; }
        li { padding: 6px 8px; border: 1px solid #9994; border-radius: 6px; margin-bottom: 6px; white-space: pre-wrap; word-break: break-word; }
        .small { font-size: 12px; color: #666; }
        .spacer { flex: 1; }
        .muted { opacity: .7; }
        .history-header { display: flex; align-items: center; gap: 8px; margin-top: 16px; }
        .nowrap { white-space: nowrap; }
    </style>
</head>

<body>
    <h1>ESP32S3 TTS Demo</h1>

    <section aria-label="音量控制">
        <div class="row">
            <strong>音量</strong>
            <button id="btnVolDec" type="button">-</button>
            <button id="btnVolInc" type="button">+</button>
            <span id="volStatus" class="small muted"></span>
        </div>
    </section>

    <section aria-label="文本输入">
        <div class="row">
            <textarea id="textInput" placeholder="在此输入文本..."></textarea>
        </div>
        <div class="row">
            <button id="btnSend" type="button">发送</button>
            <span id="sendStatus" class="small muted"></span>
        </div>
    </section>

    <section aria-label="历史">
        <div class="history-header">
            <strong>历史</strong>
            <span class="small muted">(最多保留 10 条)</span>
            <div class="spacer"></div>
            <button id="btnClearHistory" type="button" class="nowrap">一键清空</button>
        </div>
        <ul id="historyList"></ul>
    </section>

    <script>
    (function() {
        const HISTORY_KEY = 'tts_history_v1';
        const MAX_HISTORY = 10;

        const el = (id) => document.getElementById(id);
        const btnVolDec = el('btnVolDec');
        const btnVolInc = el('btnVolInc');
        const volStatus = el('volStatus');
        const textInput = el('textInput');
        const btnSend = el('btnSend');
        const sendStatus = el('sendStatus');
        const btnClearHistory = el('btnClearHistory');
        const historyList = el('historyList');

        function readHistory() {
            try {
                const raw = localStorage.getItem(HISTORY_KEY);
                if (!raw) return [];
                const arr = JSON.parse(raw);
                return Array.isArray(arr) ? arr : [];
            } catch (_) { return []; }
        }

        function writeHistory(items) {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(items.slice(0, MAX_HISTORY)));
            } catch (_) {}
        }

        function renderHistory() {
            const items = readHistory();
            historyList.innerHTML = '';
            if (items.length === 0) {
                const li = document.createElement('li');
                li.className = 'muted';
                li.textContent = '暂无历史';
                historyList.appendChild(li);
                return;
            }
            items.forEach((text, idx) => {
                const li = document.createElement('li');
                li.textContent = text;
                li.title = '点击将此文本填入输入框';
                li.addEventListener('click', () => {
                    textInput.value = text;
                    textInput.focus();
                });
                historyList.appendChild(li);
            });
        }

        async function callVolume(op) {
            const buttons = [btnVolDec, btnVolInc];
            buttons.forEach(b => b.disabled = true);
            volStatus.textContent = '正在设置...';
            try {
                const resp = await fetch('/api/volume', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ op })
                });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                volStatus.textContent = '已调整 (' + (op === 'inc' ? '+' : '-') + ')';
            } catch (e) {
                volStatus.textContent = '失败：' + (e && e.message ? e.message : '未知错误');
            } finally {
                setTimeout(() => { volStatus.textContent = ''; }, 1200);
                buttons.forEach(b => b.disabled = false);
            }
        }

        async function sendText() {
            const text = (textInput.value || '').trim();
            if (!text) {
                sendStatus.textContent = '请输入文本';
                return;
            }
            btnSend.disabled = true;
            sendStatus.textContent = '发送中...';
            try {
                const resp = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                // 更新历史（最新在前）
                const items = readHistory();
                const newItems = [text, ...items.filter(t => t !== text)].slice(0, MAX_HISTORY);
                writeHistory(newItems);
                renderHistory();
                sendStatus.textContent = '已发送';
            } catch (e) {
                sendStatus.textContent = '失败：' + (e && e.message ? e.message : '未知错误');
            } finally {
                btnSend.disabled = false;
                setTimeout(() => { sendStatus.textContent = ''; }, 1200);
            }
        }

        function clearHistory() {
            writeHistory([]);
            renderHistory();
        }

        // events
        btnVolDec.addEventListener('click', () => callVolume('dec'));
        btnVolInc.addEventListener('click', () => callVolume('inc'));
        btnSend.addEventListener('click', sendText);
        textInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                sendText();
            }
        });
        btnClearHistory.addEventListener('click', clearHistory);

        // init
        renderHistory();
    })();
    </script>
    
</body>
</html>

